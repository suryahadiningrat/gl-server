#!/bin/bash

# README: Enhanced Generate Config dengan Incremental Merge & Grid Layer

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   Enhanced Tileserver Config Generator dengan Grid Layer      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“‹ NEW FEATURES:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "1. âœ¨ INCREMENTAL MERGE - Hanya merge file baru (tidak dari awal)"
echo "2. ğŸ—ºï¸  GRID LAYER - Tambah layer SHP sebagai base layer"
echo "3. ğŸ“Š MERGE TRACKING - Log file yang sudah dimerge"
echo "4. âš¡ FAST UPDATES - Upload file baru jadi cepat!"
echo ""

echo "ğŸ¯ LAYER STACK (dari bawah ke atas):"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Layer 1 (Bottom): Grid 36 HA (pink grid - dari SHP)"
echo "  Layer 2 (Top):    GLMap (drone imagery - dari mbtiles)"
echo ""

echo "ğŸ“‚ FILE STRUCTURE:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "/app/data/"
echo "â”œâ”€â”€ GRID_DRONE_36_HA_EKSISTING_POTENSI 3/"
echo "â”‚   â””â”€â”€ GRID_36_HA_EKSISTING_POTENSI.shp  (Grid shapefile)"
echo "â”œâ”€â”€ grid_layer.mbtiles                     (Converted grid - created once)"
echo "â”œâ”€â”€ glmap.mbtiles                          (Merged drone tiles)"
echo "â”œâ”€â”€ .merged_files.log                      (Tracking merged files)"
echo "â””â”€â”€ *.mbtiles                              (Individual drone imagery)"
echo ""

echo "ğŸš€ INSTALLATION & SETUP:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Step 1: Install Tippecanoe (untuk vector tiles)"
echo "  ./install-tippecanoe.sh"
echo ""
echo "Step 2 (Alternative): Jika tippecanoe gagal, gunakan GDAL"
echo "  ./convert-grid-raster.sh"
echo ""
echo "Step 3: Run generate config pertama kali"
echo "  ./generate-config-incremental.sh"
echo ""

echo "ğŸ’¡ WORKFLOW - FIRST TIME:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "1. Upload semua file .mbtiles ke /app/data/"
echo "2. Pastikan folder GRID_DRONE_36_HA_EKSISTING_POTENSI 3/ ada"
echo "3. Run: ./generate-config-incremental.sh"
echo "4. Wait... (pertama kali akan merge semua file)"
echo "5. Done! Container restart otomatis"
echo ""

echo "âš¡ WORKFLOW - UPLOAD FILE BARU:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "1. Upload file baru .mbtiles ke /app/data/"
echo "2. Run: ./generate-config-incremental.sh"
echo "3. Done! (hanya merge file baru - SUPER CEPAT!)"
echo ""

echo "ğŸ“Š HOW IT WORKS:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Incremental Merge Logic:"
echo "  â€¢ Script check file .merged_files.log"
echo "  â€¢ Cari file yang belum ada di log"
echo "  â€¢ Merge hanya file baru ke glmap.mbtiles"
echo "  â€¢ Update log dengan file yang baru dimerge"
echo "  â€¢ Total waktu: ~2-5 detik untuk 1 file baru!"
echo ""

echo "Grid Layer:"
echo "  â€¢ Convert SHP ke mbtiles (sekali saja)"
echo "  â€¢ Simpan sebagai grid_layer.mbtiles"
echo "  â€¢ Tampil sebagai base layer (pink grid)"
echo "  â€¢ GLMap tampil di atasnya (overlay)"
echo ""

echo "ğŸ¨ STYLE CONFIGURATION:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "File: /app/styles/default/style.json"
echo "Layers:"
echo "  1. grid-fill   - Pink semi-transparent fill"
echo "  2. grid-line   - Blue outline"
echo "  3. glmap-raster - Drone imagery overlay"
echo ""

echo "âš™ï¸  CONFIGURATION OPTIONS:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Environment Variables:"
echo "  DATA_DIR=/custom/path        - Custom data directory"
echo "  SKIP_DB_UPDATE=true          - Skip PostgreSQL update"
echo "  FORCE_STYLE_UPDATE=true      - Recreate style.json"
echo "  MERGE_LOG=/custom/.log       - Custom merge log location"
echo ""

echo "ğŸ”§ TROUBLESHOOTING:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Q: Grid layer tidak muncul?"
echo "A: Install tippecanoe atau run convert-grid-raster.sh"
echo ""
echo "Q: Ingin reset dan merge ulang semua?"
echo "A: rm /app/data/.merged_files.log && rm /app/data/glmap.mbtiles"
echo ""
echo "Q: File baru tidak kemerge?"
echo "A: Check .merged_files.log - pastikan filename belum ada di sana"
echo ""
echo "Q: Ingin lihat file mana saja yang sudah dimerge?"
echo "A: cat /app/data/.merged_files.log"
echo ""

echo "ğŸ“ˆ PERFORMANCE COMPARISON:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Traditional (merge all from scratch):"
echo "  â€¢ 50 files Ã— 1365 tiles = ~2-5 minutes"
echo ""
echo "Incremental (new approach):"
echo "  â€¢ First run: same as traditional (one time)"
echo "  â€¢ Subsequent: 1 new file = ~2-5 seconds âš¡"
echo "  â€¢ 10x - 100x FASTER!"
echo ""

echo "âœ… EXPECTED RESULTS:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Web interface akan menampilkan:"
echo "  1. Grid layer (pink grid 36 HA)"
echo "  2. GLMap (merged drone imagery di atas grid)"
echo "  3. Individual drone files (optional viewing)"
echo ""

echo "Total datasets: ~60+ (grid + glmap + individual files)"
echo "Loading time: Minimal (incremental merge)"
echo "Visual result: Grid dengan drone imagery overlay âœ¨"
echo ""

echo "ğŸ“ FILES CREATED:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "/app/data/grid_layer.mbtiles    - Grid base layer (created once)"
echo "/app/data/glmap.mbtiles          - Merged drone imagery"
echo "/app/data/.merged_files.log      - Tracking log"
echo "/app/config.json                 - Tileserver config"
echo "/app/styles/default/style.json   - Multi-layer style"
echo ""

echo "ğŸ¯ READY TO USE!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Run this to start:"
echo "  chmod +x generate-config-incremental.sh"
echo "  ./generate-config-incremental.sh"
echo ""